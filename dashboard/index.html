<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pulse</title>
  <link rel="icon" href="/favicon.ico" type="image/png">
  <link rel="stylesheet" href="/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
  <div class="top-stripe"></div>
  <div id="app"></div>

  <script type="module">
    import { h, render } from 'https://esm.sh/preact@10.19.3';
    import { useState, useEffect, useRef } from 'https://esm.sh/preact@10.19.3/hooks';
    import htm from 'https://esm.sh/htm@3.1.1';

    const html = htm.bind(h);

    // ── API ─────────────────────────────────────────────────
    const API = '/api';
    async function api(path) {
      try {
        const res = await fetch(API + path);
        return res.json();
      } catch (_) { return null; }
    }

    // ── Utility ─────────────────────────────────────────────
    function msToHuman(ms) {
      if (ms == null) return '0 ms';
      const sign = ms < 0 ? '-' : '';
      ms = Math.abs(ms);
      const u = [['ms', 1000], ['s', 60], ['min', 60], ['h', 24], ['d', 7], ['w', 4.345], ['mo', 12], ['y', Infinity]];
      let v = ms;
      for (const [l, n] of u) { if (v < n || n === Infinity) return sign + v.toFixed(2) + ' ' + l; v /= n; }
      return sign + v.toFixed(2) + ' y';
    }
    function mbToHuman(mb) {
      if (mb == null) return '0 MB';
      const sign = mb < 0 ? '-' : '';
      mb = Math.abs(mb);
      const u = ['MB', 'GB', 'TB', 'PB']; let v = mb, i = 0;
      while (v >= 1024 && i < u.length - 1) { v /= 1024; i++; }
      return sign + v.toFixed(2) + ' ' + u[i];
    }
    function fmtPct(v) { return v != null ? (v * 100).toFixed(2) + ' %' : '0 %'; }

    // ── StatusDot ───────────────────────────────────────────
    function StatusDot({ label, status }) {
      const icons = { running: '\u{1F7E2}', active: '\u{1F7E1}', error: '\u{1F534}', 'no connection': '\u{26AA}' };
      return html`
    <div class="status-dot">
      ${icons[status] || '\u{26AA}'}
      <span class="tooltip">${label}: ${status}</span>
    </div>
  `;
    }

    // ── Sidebar ─────────────────────────────────────────────
    function Sidebar({ status, instances, criticalIds, selectedIds, onSelect, timeWindow, onWindowChange, collapsed }) {
      function toggleId(id) {
        if (selectedIds.includes(id)) onSelect(selectedIds.filter(x => x !== id));
        else onSelect([...selectedIds, id].sort((a, b) => a - b));
      }
      return html`
    <aside class="sidebar ${collapsed ? 'collapsed' : ''}">
      <img src="/logo.png" alt="Pulse" class="logo" />

      <div class="sidebar-section">
        <h3>Status</h3>
        <div class="status-row">
          <${StatusDot} label="Stream Analytics" status=${status.stream_analytics} />
          <${StatusDot} label="Anomaly Detection" status=${status.anomaly_detection} />
          <${StatusDot} label="Database" status=${status.cloud_database} />
        </div>
      </div>

      <div class="sidebar-section">
        <h3>Window</h3>
        <select value=${timeWindow} onChange=${e => onWindowChange(e.target.value)}>
          <option value="24h">24 h</option>
          <option value="1week">1 week</option>
        </select>
      </div>

      <div class="sidebar-section">
        <h3>Instance IDs</h3>
        <div class="btn-row">
          <button class="btn" onClick=${() => onSelect([...instances])}>All</button>
          <button class="btn ghost" onClick=${() => onSelect([])}>Deselect</button>
          <button class="btn" onClick=${() => onSelect([...criticalIds])}>Critical</button>
        </div>
        <div class="chip-grid">
          ${instances.map(id => html`
            <span class="chip ${selectedIds.includes(id) ? 'selected' : ''}" onClick=${() => toggleId(id)}>${id}</span>
          `)}
        </div>
      </div>
    </aside>
  `;
    }

    // ── InstanceSelector ────────────────────────────────────
    function InstanceSelector({ ids, active, onActive }) {
      if (ids.length <= 1) return null;
      return html`
    <div class="instance-selector">
      <button class="btn ${active === 'Selection' ? 'primary' : ''}" onClick=${() => onActive('Selection')}>Selection</button>
      <select value=${active} onChange=${e => onActive(e.target.value)}>
        <option value="Selection" disabled>Choose instance…</option>
        ${ids.map(id => html`<option value=${id} selected=${String(active) === String(id)}>${id}</option>`)}
      </select>
    </div>
  `;
    }

    // ── BadgeRow ────────────────────────────────────────────
    function BadgeRow({ types }) {
      if (!types || types.length === 0) return null;
      const labels = { cpu_bound: 'CPU-bound', io_bound: 'IO-bound', network_bound: 'Network-bound', queue_wlm_bound: 'Queue/WLM-bound' };
      const sev = { cpu_bound: 'error', io_bound: 'error', network_bound: 'warn', queue_wlm_bound: 'warn' };
      return html`
    <div class="badge-row">
      ${types.map(t => html`<span class="badge ${sev[t] || 'warn'}">${labels[t] || t}</span>`)}
    </div>
  `;
    }

    // ── MetricCard ──────────────────────────────────────────
    function MetricCard({ label, value, delta, inverse }) {
      let cls = '';
      const displayVal = (value != null && value !== '') ? value : '\u2014';
      if (delta != null) {
        const n = typeof delta === 'string' ? parseFloat(delta) : delta;
        if (inverse) cls = n > 0 ? 'inverse-positive' : n < 0 ? 'inverse-negative' : '';
        else cls = n > 0 ? 'positive' : n < 0 ? 'negative' : '';
      }
      const arr = delta != null ? (parseFloat(String(delta)) > 0 ? '\u2191 ' : parseFloat(String(delta)) < 0 ? '\u2193 ' : '') : '';
      return html`
    <div class="metric-card">
      <div class="metric-label">${label}</div>
      <div class="metric-value">${displayVal}</div>
      ${delta != null && html`<div class="metric-delta ${cls}">${arr}${delta}</div>`}
    </div>
  `;
    }

    // ── MetricsSection ──────────────────────────────────────
    function MetricsSection({ metrics, activeIds, active }) {
      if (!metrics) return null;
      const cards = [];
      if (active === 'Selection' && activeIds.length > 1) cards.push({ label: 'Instances', value: '#' + activeIds.length });
      else if (active !== 'Selection') cards.push({ label: 'Instance ID', value: active });
      if (activeIds.length === 1 && metrics.cluster_size != null)
        cards.push({ label: 'Cluster Size', value: metrics.cluster_size === -1 ? 'None' : metrics.cluster_size });
      cards.push({ label: 'Score', value: fmtPct(metrics.score), delta: fmtPct(metrics.score_delta) });
      cards.push({ label: 'Spillage', value: mbToHuman(metrics.spilled_mb), delta: mbToHuman(metrics.spilled_mb_delta), inverse: true });
      cards.push({ label: 'Queue Time', value: msToHuman(metrics.queue_time), delta: msToHuman(metrics.queue_time_delta), inverse: true });
      cards.push({ label: 'Queue Ratio', value: fmtPct(metrics.queue_ratio), delta: fmtPct(metrics.queue_ratio_delta), inverse: true });
      cards.push({ label: 'Anomaly Queries', value: metrics.anomalies_count ?? 0, delta: metrics.anomalies_count_delta, inverse: true });
      return html`
    <div class="metrics-grid">
      ${cards.map(c => html`<${MetricCard} ...${c} />`)}
    </div>
  `;
    }

    // ── AreaChart ────────────────────────────────────────────
    function AreaChart({ data, timeWindow }) {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      // Compute date range subtitle from data
      const dateRange = (() => {
        if (!data || data.length === 0) return '';
        const first = new Date(data[0].window_start);
        const last = new Date(data[data.length - 1].window_start);
        const fmt = d => d.toLocaleDateString([], { month: 'short', day: 'numeric' });
        return first.toDateString() === last.toDateString()
          ? fmt(last)
          : fmt(first) + ' \u2013 ' + fmt(last);
      })();

      useEffect(() => {
        if (!data || data.length === 0) return;
        async function go() {
          if (!window.Chart) {
            const mod = await import('https://esm.sh/chart.js@4.4.4/auto');
            window.Chart = mod.default || mod.Chart;
          }
          const Chart = window.Chart;
          const ctx = canvasRef.current;
          if (!ctx) return;

          // Store full Date objects for tooltips
          const dates = data.map(r => new Date(r.window_start));

          // X-axis labels: show date prefix when the day changes
          const labels = dates.map((d, i) => {
            const time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            if (i === 0 || d.toDateString() !== dates[i - 1].toDateString()) {
              return d.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + time;
            }
            return time;
          });

          const series = [
            { key: 'cpu_bound_queries', label: 'CPU-bound', color: '#C62828' },
            { key: 'io_bound_queries', label: 'IO-bound', color: '#EF5350' },
            { key: 'network_bound_queries', label: 'Network-bound', color: '#F9A825' },
            { key: 'queue_wlm_bound_queries', label: 'Queue/WLM-bound', color: '#FDD835' },
            { key: 'normal_queries', label: 'Normal', color: '#2E7D32' },
          ];
          const totals = data.map(r => series.reduce((s, se) => s + (r[se.key] || 0), 0));
          const datasets = series.map(s => ({
            label: s.label,
            data: data.map((r, i) => totals[i] > 0 ? ((r[s.key] || 0) / totals[i]) * 100 : 0),
            backgroundColor: s.color + '99', borderColor: s.color, borderWidth: 1,
            fill: true, tension: 0.3, pointRadius: 0,
          }));
          if (chartRef.current) chartRef.current.destroy();
          chartRef.current = new Chart(ctx, {
            type: 'line', data: { labels, datasets },
            options: {
              responsive: true, maintainAspectRatio: false,
              interaction: { mode: 'index', intersect: false },
              plugins: {
                legend: { position: 'bottom', labels: { color: '#E6EDF3', font: { family: 'Inter', size: 11 }, boxWidth: 12, padding: 16 } },
                tooltip: {
                  backgroundColor: 'rgba(14,17,23,0.9)', titleColor: '#E6EDF3', bodyColor: '#E6EDF3',
                  borderColor: 'rgba(229,57,53,0.3)', borderWidth: 1,
                  callbacks: {
                    title: ctx => {
                      const idx = ctx[0].dataIndex;
                      const d = dates[idx];
                      return d.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' }) + '  ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }
                  }
                }
              },
              scales: {
                x: { ticks: { color: '#E6EDF380', font: { size: 10 }, maxRotation: 45, autoSkip: true, maxTicksLimit: 24 }, grid: { color: 'rgba(255,255,255,0.04)' } },
                y: { stacked: true, min: 0, max: 100, ticks: { color: '#E6EDF380', callback: v => v + '%' }, grid: { color: 'rgba(255,255,255,0.04)' } }
              }
            }
          });
        }
        go();
        return () => { if (chartRef.current) chartRef.current.destroy(); };
      }, [data]);

      if (!data || data.length === 0) return html`<div class="empty-state">Waiting for chart data\u2026</div>`;
      return html`
    <div>
      ${dateRange && html`<div class="chart-date-range">${dateRange}</div>`}
      <div class="chart-container" style="height:360px">
        <canvas ref=${canvasRef}></canvas>
      </div>
    </div>
  `;
    }

    // ── AnomalyTable ────────────────────────────────────────
    function AnomalyTable({ anomalies }) {
      const [open, setOpen] = useState(false);
      const [extended, setExtended] = useState(false);
      const rm = { underestimated_ratio: 'Ratio', underestimated_delta: 'Delta', misrank_quantiles: 'Quantile' };
      const sCols = ['instance_id', 'arrival_timestamp', 'query_id', 'anomaly_reason'];
      const aCols = ['instance_id', 'arrival_timestamp', 'query_id', 'anomaly_reason', 'user_id', 'database_id', 'absolute_delta', 'relative_delta'];
      const lbl = { instance_id: 'Instance', arrival_timestamp: 'Arrived', query_id: 'Query ID', anomaly_reason: 'Reason', user_id: 'User', database_id: 'Database', absolute_delta: '\u0394 Abs', relative_delta: '\u0394 %' };
      const cols = extended ? aCols : sCols;
      const rows = anomalies || [];
      function fmt(c, v) {
        if (c === 'anomaly_reason') return rm[v] || v;
        if (c === 'arrival_timestamp' && v) { const d = new Date(v); return d.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); }
        if ((c === 'absolute_delta' || c === 'relative_delta') && v != null) return Number(v).toFixed(2);
        return v ?? '';
      }
      return html`
    <div class="expander ${open ? 'open' : ''}">
      <div class="expander-header" onClick=${() => setOpen(!open)}>
        <span class="arrow">\u25B6</span> Anomaly Details (${rows.length})
      </div>
      <div class="expander-body">
        <div class="toggle-switch-row">
          <label class="toggle-switch">
            <input type="checkbox" checked=${extended} onChange=${() => setExtended(!extended)} />
            <span class="slider"></span>
          </label>
          Extended View
        </div>
        ${rows.length === 0
          ? html`<div style="color:var(--text-muted);font-size:0.85rem">No anomalies in this window.</div>`
          : html`
            <div style="overflow-x:auto">
              <table class="data-table">
                <thead><tr>${cols.map(c => html`<th>${lbl[c]}</th>`)}</tr></thead>
                <tbody>${rows.map(r => html`
                  <tr>${cols.map(c => html`<td>${fmt(c, r[c])}</td>`)}</tr>
                `)}</tbody>
              </table>
            </div>
          `
        }
      </div>
    </div>
  `;
    }

    // ── ClassificationTable ─────────────────────────────────
    function ClassificationTable({ data }) {
      if (!data || Object.keys(data).length === 0) return html`<div class="empty-state">No data</div>`;
      const rows = [
        { type: 'Total', count: data.total_queries, pct: 1 },
        { type: 'Normal', count: data.normal_queries, pct: data.normal_queries_pct },
        { type: 'CPU', count: data.cpu_bound_queries, pct: data.cpu_bound_queries_pct },
        { type: 'IO', count: data.io_bound_queries, pct: data.io_bound_queries_pct },
        { type: 'Network', count: data.network_bound_queries, pct: data.network_bound_queries_pct },
        { type: 'Queue/WLM', count: data.queue_wlm_bound_queries, pct: data.queue_wlm_bound_queries_pct },
        { type: 'Anomalies', count: data.anomalies_count, pct: data.anomalies_pct },
      ];
      return html`
    <div class="glass-panel">
      <h4>Query Classification</h4>
      <table class="data-table">
        <thead><tr><th>Type</th><th>Count</th><th>%</th></tr></thead>
        <tbody>${rows.map(r => html`
          <tr>
            <td>${r.type}</td>
            <td>${r.count != null ? Math.round(r.count).toLocaleString() : 0}</td>
            <td>${r.pct != null ? (r.pct * 100).toFixed(1) : '0.0'}</td>
          </tr>
        `)}</tbody>
      </table>
    </div>
  `;
    }

    // ── Recommendations ─────────────────────────────────────
    function Recommendations({ types }) {
      const [open, setOpen] = useState(false);
      const [texts, setTexts] = useState({});
      const effectiveTypes = (!types || types.length === 0) ? ['normal'] : types;
      useEffect(() => {
        effectiveTypes.forEach(async t => {
          if (!texts[t]) {
            const res = await api('/recommendations/' + t);
            setTexts(prev => ({ ...prev, [t]: res.text }));
          }
        });
      }, [effectiveTypes.join(',')]);
      function renderMd(text) {
        return text.split('\n').map((line, i) => {
          line = line.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
          if (line.startsWith('- ')) return html`<li key=${i} dangerouslySetInnerHTML=${{ __html: line.slice(2) }}></li>`;
          if (line.trim() === '') return null;
          return html`<p key=${i} dangerouslySetInnerHTML=${{ __html: line }} style="margin-bottom:4px"></p>`;
        });
      }
      return html`
    <div class="expander ${open ? 'open' : ''}">
      <div class="expander-header" onClick=${() => setOpen(!open)}>
        <span class="arrow">\u25B6</span> Recommendations
      </div>
      <div class="expander-body">
        ${effectiveTypes.map(t => html`
          <div class="recommendation-text" key=${t}>
            ${texts[t] ? renderMd(texts[t]) : 'Loading\u2026'}
          </div>
        `)}
        <a href="https://aws.amazon.com/de/contact-us/#cb-open" target="_blank" class="btn primary" style="display:block;margin-top:14px;text-decoration:none;padding:10px">Contact AWS</a>
      </div>
    </div>
  `;
    }

    // ── Right Drawer ────────────────────────────────────────
    function RightDrawer({ open, onToggle, tableData, criticalTypes }) {
      return html`
    <button class="drawer-tab ${open ? 'open' : ''}" onClick=${onToggle}>
      ${open ? '\u2715' : 'Details'}
    </button>
    <div class="right-drawer ${open ? '' : 'closed'}">
      <div class="right-drawer-header">
        <h3>Details</h3>
        <button class="drawer-close-btn" onClick=${onToggle}>\u2715</button>
      </div>
      <div class="right-drawer-content">
        <${ClassificationTable} data=${tableData} />
        <${Recommendations} types=${criticalTypes} />
      </div>
    </div>
  `;
    }

    // ── App ─────────────────────────────────────────────────
    function App() {
      const [status, setStatus] = useState({ stream_analytics: 'no connection', anomaly_detection: 'no connection', cloud_database: 'no connection' });
      const [instances, setInstances] = useState([]);
      const [criticalIds, setCriticalIds] = useState([]);
      const [selectedIds, setSelectedIds] = useState([]);
      const [active, setActive] = useState('Selection');
      const [timeWindow, setTimeWindow] = useState('24h');
      const [metrics, setMetrics] = useState(null);
      const [chartData, setChartData] = useState([]);
      const [tableData, setTableData] = useState({});
      const [anomalies, setAnomalies] = useState([]);
      const [criticalTypes, setCriticalTypes] = useState([]);
      const [drawerOpen, setDrawerOpen] = useState(true);
      const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        async function init() {
          const [st, inst, crit] = await Promise.all([
            api('/status'),
            api('/instances?window=' + timeWindow),
            api('/instances/critical?window=' + timeWindow)
          ]);
          setStatus(st);
          setInstances(inst);
          setCriticalIds(crit);
          setLoading(false);
        }
        init();
      }, [timeWindow]);

      const activeIds = active === 'Selection' ? selectedIds : [parseInt(active)];

      useEffect(() => {
        if (activeIds.length === 0) return;
        const idsStr = activeIds.join(',');
        const w = timeWindow;
        Promise.all([
          api('/metrics?ids=' + idsStr + '&window=' + w),
          api('/classification/chart?ids=' + idsStr + '&window=' + w),
          api('/classification/table?ids=' + idsStr + '&window=' + w),
          api('/anomalies?ids=' + idsStr + '&window=' + w),
          api('/critical/types?ids=' + idsStr + '&window=' + w),
        ]).then(([m, ch, tb, an, ct]) => {
          if (m) setMetrics(m); if (ch) setChartData(ch); if (tb) setTableData(tb);
          if (an) setAnomalies(an); if (ct) setCriticalTypes(ct);
        });
      }, [activeIds.join(','), timeWindow]);

      useEffect(() => {
        let fails = 0;
        const interval = setInterval(async () => {
          if (activeIds.length === 0) return;
          const idsStr = activeIds.join(',');
          const w = timeWindow;
          try {
            const [st, m, ch, tb, an, ct] = await Promise.all([
              api('/status'),
              api('/metrics?ids=' + idsStr + '&window=' + w),
              api('/classification/chart?ids=' + idsStr + '&window=' + w),
              api('/classification/table?ids=' + idsStr + '&window=' + w),
              api('/anomalies?ids=' + idsStr + '&window=' + w),
              api('/critical/types?ids=' + idsStr + '&window=' + w),
            ]);
            if (!st) { fails++; } else { fails = 0; }
            if (fails >= 3) {
              clearInterval(interval);
              setStatus({ stream_analytics: 'no connection', anomaly_detection: 'no connection', cloud_database: 'no connection' });
              return;
            }
            if (st) setStatus(st); if (m) setMetrics(m); if (ch) setChartData(ch);
            if (tb) setTableData(tb); if (an) setAnomalies(an); if (ct) setCriticalTypes(ct);
          } catch (_) { fails++; if (fails >= 3) clearInterval(interval); }
        }, 30000);
        return () => clearInterval(interval);
      }, [activeIds.join(','), timeWindow]);

      function handleSelect(ids) {
        setSelectedIds(ids.sort((a, b) => a - b));
        setActive('Selection');
      }

      if (loading) return html`<div class="loading"><div class="spinner"></div>Connecting to Pulse\u2026</div>`;

      const hasSelection = selectedIds.length > 0;

      return html`
    <div class="app-shell">
      <button class="sidebar-toggle" onClick=${() => setSidebarCollapsed(!sidebarCollapsed)}>
        ${sidebarCollapsed ? '\u25B6' : '\u25C0'}
      </button>

      <${Sidebar}
        status=${status}
        instances=${instances}
        criticalIds=${criticalIds}
        selectedIds=${selectedIds}
        onSelect=${handleSelect}
        timeWindow=${timeWindow}
        onWindowChange=${setTimeWindow}
        collapsed=${sidebarCollapsed}
      />

      <main class="main-area ${drawerOpen ? 'with-drawer' : 'no-drawer'}">
        ${!hasSelection
          ? html`<div class="empty-state" style="margin-top:60px">\u26A0\uFE0F Please select an instance in the sidebar.</div>`
          : html`
            <${InstanceSelector} ids=${selectedIds} active=${active} onActive=${setActive} />
            <${BadgeRow} types=${criticalTypes} />
            <${MetricsSection} metrics=${metrics} activeIds=${activeIds} active=${active} />
            <${AreaChart} data=${chartData} timeWindow=${timeWindow} />
            <${AnomalyTable} anomalies=${anomalies} />
          `
        }
      </main>

      ${hasSelection && html`
        <${RightDrawer}
          open=${drawerOpen}
          onToggle=${() => setDrawerOpen(!drawerOpen)}
          tableData=${tableData}
          criticalTypes=${criticalTypes}
        />
      `}
    </div>
  `;
    }

    render(html`<${App} />`, document.getElementById('app'));
  </script>
</body>

</html>